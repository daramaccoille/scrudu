<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Technology Exam Prototype</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .question-card {
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .question-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .large-text-area {
            font-size: 1.25rem;
        }
        .answers-container {
            border-radius: 8px;
            transition: max-height 0.5s ease-in-out;
            overflow: hidden;
            max-height: 0;
        }
        .answers-container.show {
            max-height: 500px; /* Adjust based on content height */
            padding: 1.5rem;
            margin-top: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="min-h-screen flex flex-col items-center p-4 md:p-8">

        <header class="w-full max-w-4xl bg-white rounded-xl shadow-lg p-6 mb-6 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-800 mb-2">Teicneolaíocht Dhigiteach</h1>
            <p class="text-lg text-slate-600">Aonad 1 2024</p>
        </header>
        
        <main id="exam-container" class="w-full max-w-4xl bg-white rounded-xl shadow-lg p-6 flex flex-col gap-6">
            <!-- Questions will be dynamically injected here by JavaScript -->
        </main>
        
        <div class="w-full max-w-4xl flex flex-col items-center mt-6 gap-4">
            <button id="submit-btn" class="w-full md:w-1/2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-colors duration-300">
                Submit Answers
            </button>
            <div id="result-message" class="hidden p-4 rounded-lg bg-green-100 text-green-700 font-semibold w-full md:w-1/2 text-center">
                Your answers have been submitted!
            </div>
            <button id="show-answers-btn" class="w-full md:w-1/2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-colors duration-300 hidden">
                Show Correct Answers
            </button>
        </div>

    </div>

    <script>
        // Application state
        const state = {
            currentLanguage: 'en',
            studentAnswers: {},
            isSubmitted: false,
            examData: {
                examId: "Scruduithe_2024",
                questions: []
            }
        };

        const examContainer = document.getElementById('exam-container');
        const submitBtn = document.getElementById('submit-btn');
        const showAnswersBtn = document.getElementById('show-answers-btn');
        const resultMessage = document.getElementById('result-message');

        const translations = {
            en: {
                question: "Question",
                selectOption: "Select an option",
                yourAnswer: "Your Answer:",
                yourScore: "Your Score:",
                correctAnswer: "Correct Answer:",
                feedback: "Feedback:",
                submitAnswers: "Submit Answers",
                showCorrectAnswers: "Show Correct Answers",
                hideAnswers: "Hide Answers",
                examSubmitted: "Exam submitted! Your score is",
                outOf: "out of"
            },
            ga: {
                question: "Ceist",
                selectOption: "Roghnaigh Freagra",
                yourAnswer: "Do Freagra:",
                yourScore: "Do Scór:",
                correctAnswer: "Freagra Ceart:",
                feedback: "Aiseolas:",
                submitAnswers: "Freagraí a sheoladh",
                showCorrectAnswers: "Taispeáin Freagraí Cearta",
                hideAnswers: "Folaigh Freagraí",
                examSubmitted: "Scrúdú curtha isteach! Is é do scór ná",
                outOf: "as"
            }
        };
        
        // --- Core Functions ---

        async function loadExamData() {
            const response = await fetch('Scruduithe.tsv');
            const tsvData = await response.text();
            const lines = tsvData.split('\r\n');
            const headers = lines[0].split('\t');
            
            state.examData.questions = lines.slice(1).map(line => {
                const values = line.split('\t');
                const question = {};
                headers.forEach((header, i) => {
                    question[header] = values[i];
                });
                return {
                    id: question.Ceist_ID,
                    number: question.ceist,
                    type: question.cineal_ceist,
                    imageEnUrl: 'scruduithe_images/' + question.snip_Bearla,
                    imageGaUrl: 'scruduithe_images/' + question.snip_Gaeilge,
                    extractedTextEn: question.ocr_Bearla,
                    extractedTextGa: question.ocr_Gaeilge,
                    correctAnswer: question.freagra_ceart,
                    maxMarks: question.marc_ar_fail,
                    feedback: {
                        en: question.ocr_freagra,
                        ga: question.ocr_freagra
                    }
                };
            });
        }

        // Saves the current state of student answers from the form inputs
        function saveAnswers() {
            state.examData.questions.forEach(q => {
                const inputElement = document.getElementById(q.id);
                if (inputElement) {
                    state.studentAnswers[q.id] = inputElement.value;
                }
            });
        }
        
        // Renders the entire exam from the examData object
        function renderExam() {
            // Save the answers before re-rendering to prevent loss of state
            if (examContainer.hasChildNodes()) {
                saveAnswers();
            }

            examContainer.innerHTML = '';
            const t = translations[state.currentLanguage];

            document.getElementById('submit-btn').textContent = t.submitAnswers;
            document.getElementById('show-answers-btn').textContent = t.showCorrectAnswers;

            state.examData.questions.forEach(q => {
                if (!q.id) return;
                const qElement = document.createElement('div');
                qElement.id = `question-${q.id}`;
                qElement.className = 'question-card bg-gray-50 p-6 flex flex-col gap-4';

                // Language toggle for each question for granular control
                const languageToggle = `
                    <div class="flex justify-end gap-2 text-sm text-gray-500">
                        <button class="lang-toggle-btn p-1 rounded-md transition-colors ${state.currentLanguage === 'en' ? 'bg-blue-200 text-blue-800' : 'hover:bg-gray-200'}" data-lang="en" data-question-id="${q.id}">English</button>
                        <button class="lang-toggle-btn p-1 rounded-md transition-colors ${state.currentLanguage === 'ga' ? 'bg-blue-200 text-blue-800' : 'hover:bg-gray-200'}" data-lang="ga" data-question-id="${q.id}">Gaeilge</button>
                    </div>
                `;
                
                const questionContent = `
                    <h3 class="text-xl font-semibold mb-2">${t.question} ${q.number}</h3>
                    <div class="question-images flex justify-center">
                        <img src="${state.currentLanguage === 'en' ? q.imageEnUrl : q.imageGaUrl}" alt="Question ${q.number} image" class="rounded-lg shadow-inner max-w-full h-auto mb-4" />
                    </div>
                `;

                let answerInput = '';
                if (q.type === 'teacs_gairid') {
                    answerInput = `
                        <label for="${q.id}" class="text-lg font-medium text-gray-700">${t.yourAnswer}</label>
                        <textarea id="${q.id}" class="large-text-area mt-1 p-3 w-full rounded-md border border-gray-300 focus:ring-blue-500 focus:border-blue-500" rows="6" ${state.isSubmitted ? 'disabled' : ''}>${state.studentAnswers[q.id] || ''}</textarea>
                    `;
                } else if (q.type === 'ilroghnach') {
                     answerInput = `
                        <label for="${q.id}" class="text-lg font-medium text-gray-700">${t.yourAnswer}</label>
                        <select id="${q.id}" class="mt-1 p-3 w-full rounded-md border border-gray-300 bg-white focus:ring-blue-500 focus:border-blue-500" ${state.isSubmitted ? 'disabled' : ''}>
                            <option value="">${t.selectOption}</option>
                            <option value="A" ${state.studentAnswers[q.id] === 'A' ? 'selected' : ''}>A</option>
                            <option value="B" ${state.studentAnswers[q.id] === 'B' ? 'selected' : ''}>B</option>
                            <option value="C" ${state.studentAnswers[q.id] === 'C' ? 'selected' : ''}>C</option>
                            <option value="D" ${state.studentAnswers[q.id] === 'D' ? 'selected' : ''}>D</option>
                        </select>
                    `;
                }

                const answerFeedback = `
                    <div id="answers-${q.id}" class="answers-container bg-white border border-gray-200 p-4 rounded-lg mt-4 transition-all duration-500">
                        <p class="font-bold text-lg mb-2 text-gray-800">${t.yourScore} <span id="score-${q.id}" class="text-green-600"></span> / ${q.maxMarks}</p>
                        <p class="font-medium text-gray-800">${t.correctAnswer} <span id="correct-${q.id}" class="text-green-600"></span></p>
                        <p class="mt-2 text-gray-600">${t.feedback} <span id="feedback-${q.id}"></span></p>
                    </div>
                `;

                qElement.innerHTML = languageToggle + questionContent + answerInput + answerFeedback;
                examContainer.appendChild(qElement);
                
                // Set the student's previously selected answer if it exists
                if (state.studentAnswers[q.id]) {
                    document.getElementById(q.id).value = state.studentAnswers[q.id];
                }
            });
            attachLanguageToggleListeners();
        }
        
        // Toggles the language for the entire exam
        function toggleLanguage(lang) {
            state.currentLanguage = lang;
            renderExam();
        }

        function attachLanguageToggleListeners() {
            document.querySelectorAll('.lang-toggle-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const lang = button.dataset.lang;
                    if (state.currentLanguage !== lang) {
                        toggleLanguage(lang);
                    }
                });
            });
        }

        // Simulates the marking process
        function markExam() {
            let totalScore = 0;
            const t = translations[state.currentLanguage];
            state.examData.questions.forEach(q => {
                if (!q.id) return;
                const studentAnswer = state.studentAnswers[q.id];
                const feedbackContainer = document.getElementById(`answers-${q.id}`);
                
                let marks = 0;
                let feedbackText = '';

                if (q.type === 'ilroghnach') {
                    marks = (studentAnswer === q.correctAnswer) ? q.maxMarks : 0;
                    feedbackText = marks > 0 ? 'Correct!' : 'Incorrect.';
                } else if (q.type === 'teacs_gairid') {
                    const studentLower = (studentAnswer || '').toLowerCase();
                    const correctLower = (q.correctAnswer || '').toLowerCase();
                    if (studentLower.includes(correctLower)) {
                        marks = q.maxMarks;
                        feedbackText = 'Great job! Full marks awarded.';
                    } else {
                        marks = 0;
                        feedbackText = 'The key concepts were not mentioned. ' + q.feedback[state.currentLanguage];
                    }
                }
                
                document.getElementById(`score-${q.id}`).textContent = marks;
                document.getElementById(`correct-${q.id}`).textContent = q.correctAnswer;
                document.getElementById(`feedback-${q.id}`).textContent = feedbackText;
                
                totalScore += parseInt(marks, 10) || 0;
            });

            const totalMarks = state.examData.questions.reduce((sum, q) => sum + (parseInt(q.maxMarks, 10) || 0), 0);
            resultMessage.textContent = `${t.examSubmitted} ${totalScore} ${t.outOf} ${totalMarks}.`;
            resultMessage.classList.remove('hidden');
        }

        // --- Event Listeners ---
        submitBtn.addEventListener('click', () => {
            if (state.isSubmitted) return;
            saveAnswers();
            state.isSubmitted = true;
            markExam();
            submitBtn.classList.add('hidden');
            showAnswersBtn.classList.remove('hidden');
            renderExam();
        });

        showAnswersBtn.addEventListener('click', () => {
            const t = translations[state.currentLanguage];
            state.examData.questions.forEach(q => {
                if (!q.id) return;
                const feedbackContainer = document.getElementById(`answers-${q.id}`);
                feedbackContainer.classList.toggle('show');
                if (feedbackContainer.classList.contains('show')) {
                    showAnswersBtn.textContent = t.hideAnswers;
                } else {
                    showAnswersBtn.textContent = t.showCorrectAnswers;
                }
            });
        });

        // Initial render
        document.addEventListener('DOMContentLoaded', async () => {
            await loadExamData();
            renderExam();
        });
    </script>
</body>
</html>